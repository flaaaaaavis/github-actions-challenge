name: Create automatic Pull Request from release into main

on:
  push:
    branches:
      - release
env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Create a label
        run: |
          labels=$(echo $(gh api -X GET /repos/${{ GITHUB.REPOSITORY }}/labels --jq='.[].name'))

          if grep -q "auto-merge" <<< $labels
          then
              echo "Label already exists"
          else
            gh api -X POST /repos/${{GITHUB.REPOSITORY }}/labels \
              -H "Accept: application/vnd.github.v3+json" \
              -f name='auto-merge' \
              -f description='Ready for new release!' \
              -f color='f29513'
            
            echo "Label was successfully created" 
          fi
      - name: Register
        run: |
          curl -X POST https://git.heroku.com/github-actions-challenge.git/register \
          -H "Content-Type: application/json" \
          -d '{"user":"CearÃ¡", "pass":"Lessa"}'
      - name: Get users
        run: curl https://git.heroku.com/github-actions-challenge.git/users
      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.AUTOPR }}
        uses: peter-evans/create-pull-request@v4
        with:
          commit-message: Update main
          title: Keep main up-to-date with release
          branch: main
          base: release